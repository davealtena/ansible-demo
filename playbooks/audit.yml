---
- name: Audit baseline compliance
  hosts: all
  become: true
  gather_facts: true

  tasks:
    # --- Automatic Updates Audit ---
    - name: "AUDIT | Check if unattended-upgrades is installed"
      ansible.builtin.package_facts:
        manager: apt

    - name: "AUDIT | Verify unattended-upgrades package"
      ansible.builtin.assert:
        that:
          - "'unattended-upgrades' in ansible_facts.packages"
        fail_msg: "FAIL: unattended-upgrades is niet geinstalleerd"
        success_msg: "PASS: unattended-upgrades is geinstalleerd"

    - name: "AUDIT | Check auto-upgrades config"
      ansible.builtin.slurp:
        src: /etc/apt/apt.conf.d/20auto-upgrades
      register: auto_upgrades_content

    - name: "AUDIT | Verify auto-upgrades enabled"
      ansible.builtin.assert:
        that:
          - "'Unattended-Upgrade \"1\"' in auto_upgrades_content.content | b64decode"
        fail_msg: "FAIL: automatische updates staan niet aan"
        success_msg: "PASS: automatische updates zijn ingeschakeld"

    # --- SSH Audit ---
    - name: "AUDIT | Read sshd_config"
      ansible.builtin.slurp:
        src: /etc/ssh/sshd_config
      register: sshd_config_content

    - name: "AUDIT | Verify SSH settings"
      ansible.builtin.assert:
        that:
          - "'PermitRootLogin prohibit-password' in sshd_config_content.content | b64decode"
          - "'PasswordAuthentication no' in sshd_config_content.content | b64decode"
          - "'MaxAuthTries 3' in sshd_config_content.content | b64decode"
        fail_msg: "FAIL: SSH configuratie is niet correct gehardened"
        success_msg: "PASS: SSH configuratie is correct gehardened"

    # --- Firewall Audit ---
    - name: "AUDIT | Check UFW status"
      ansible.builtin.command: ufw status verbose
      register: ufw_status
      changed_when: false

    - name: "AUDIT | Show UFW status"
      ansible.builtin.debug:
        msg: "{{ ufw_status.stdout_lines }}"

    - name: "AUDIT | Verify UFW is active"
      ansible.builtin.assert:
        that:
          - "'Status: active' in ufw_status.stdout"
        fail_msg: "FAIL: UFW firewall is niet actief"
        success_msg: "PASS: UFW firewall is actief"

    - name: "AUDIT | Verify UFW default deny incoming"
      ansible.builtin.assert:
        that:
          - "'Default: deny (incoming)' in ufw_status.stdout"
        fail_msg: "FAIL: UFW default incoming is niet deny"
        success_msg: "PASS: UFW default incoming is deny"

    # --- Sysctl Audit ---
    - name: "AUDIT | Check sysctl hardening values"
      ansible.builtin.command: "sysctl {{ item.key }}"
      register: sysctl_results
      changed_when: false
      loop:
        - {key: "net.ipv4.ip_forward", value: "0"}
        - {key: "net.ipv4.conf.all.accept_redirects", value: "0"}
        - {key: "net.ipv4.tcp_syncookies", value: "1"}

    - name: "AUDIT | Verify sysctl values"
      ansible.builtin.assert:
        that:
          - "item.stdout.split('=')[1] | trim == item.item.value"
        fail_msg: "FAIL: {{ item.item.key }} = {{ item.stdout.split('=')[1] | trim }} (verwacht: {{ item.item.value }})"
        success_msg: "PASS: {{ item.item.key }} = {{ item.item.value }}"
      loop: "{{ sysctl_results.results }}"
      loop_control:
        label: "{{ item.item.key }}"

    # --- MOTD Audit ---
    - name: "AUDIT | Read MOTD"
      ansible.builtin.slurp:
        src: /etc/motd
      register: motd_content

    - name: "AUDIT | Verify MOTD content"
      ansible.builtin.assert:
        that:
          - "'Beheerd door Ansible via Semaphore' in motd_content.content | b64decode"
        fail_msg: "FAIL: MOTD bevat niet de verwachte tekst"
        success_msg: "PASS: MOTD is correct geconfigureerd"

    # --- Summary ---
    - name: "AUDIT | Compliance samenvatting"
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "  AUDIT RESULTAAT - {{ inventory_hostname }}"
          - "============================================"
          - "  Updates  : unattended-upgrades actief"
          - "  SSH      : gehardened"
          - "  UFW      : actief met default deny"
          - "  Sysctl   : kernel hardening toegepast"
          - "  MOTD     : correct geconfigureerd"
          - "============================================"
          - "  Alle checks PASSED"
          - "============================================"
