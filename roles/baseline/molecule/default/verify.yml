---
- name: Verify baseline configuration
  hosts: all
  become: true
  gather_facts: true

  tasks:
    # --- Updates Verification ---
    - name: "VERIFY | Check unattended-upgrades is installed"
      ansible.builtin.package_facts:
        manager: apt

    - name: "VERIFY | Assert unattended-upgrades is present"
      ansible.builtin.assert:
        that:
          - "'unattended-upgrades' in ansible_facts.packages"

    - name: "VERIFY | Check auto-upgrades config exists"
      ansible.builtin.stat:
        path: /etc/apt/apt.conf.d/20auto-upgrades
      register: auto_upgrades_stat

    - name: "VERIFY | Assert auto-upgrades config exists"
      ansible.builtin.assert:
        that:
          - auto_upgrades_stat.stat.exists

    # --- SSH Verification ---
    - name: "VERIFY | Read sshd_config"
      ansible.builtin.slurp:
        src: /etc/ssh/sshd_config
      register: sshd_config

    - name: "VERIFY | Assert SSH hardening settings"
      ansible.builtin.assert:
        that:
          - "'PermitRootLogin prohibit-password' in sshd_config.content | b64decode"
          - "'PasswordAuthentication no' in sshd_config.content | b64decode"
          - "'MaxAuthTries 3' in sshd_config.content | b64decode"
          - "'X11Forwarding no' in sshd_config.content | b64decode"

    - name: "VERIFY | Check sshd_config permissions"
      ansible.builtin.stat:
        path: /etc/ssh/sshd_config
      register: sshd_stat

    - name: "VERIFY | Assert sshd_config is 0600"
      ansible.builtin.assert:
        that:
          - "sshd_stat.stat.mode == '0600'"

    # --- Firewall Verification ---
    - name: "VERIFY | Check UFW is installed"
      ansible.builtin.assert:
        that:
          - "'ufw' in ansible_facts.packages"

    # --- MOTD Verification ---
    - name: "VERIFY | Read MOTD file"
      ansible.builtin.slurp:
        src: /etc/motd
      register: motd_file

    - name: "VERIFY | Assert MOTD contains expected message"
      ansible.builtin.assert:
        that:
          - "'Beheerd door Ansible via Semaphore' in motd_file.content | b64decode"

    - name: "VERIFY | Check MOTD permissions"
      ansible.builtin.stat:
        path: /etc/motd
      register: motd_stat

    - name: "VERIFY | Assert MOTD is 0644"
      ansible.builtin.assert:
        that:
          - "motd_stat.stat.mode == '0644'"
